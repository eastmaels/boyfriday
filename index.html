<!doctype html>
<html lang="en">
  <head>
    <title>Boy Friday</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">

  </head>
  <body>
    <div class="container">
      <h1>Boy Friday</h1>
      <p class="lead">A simple post notification.</p>

      <h3>Notification Conditions</h3>
      <p>These are the conditions that will be considered to get notifications.</p>
    
      <div class="row">
        <div class="col-md-12">
          <form>
          <table id="rule-table" class= 'table table-hover'>
            <thead>
                <tr>
                  <th>Condition</th>
                  <th>Field</th>
                  <th>Operation</th>
                  <th>Value</th>
                  <th>Action</th>
                </tr>
            </thead>
            <tbody>
              <tr class="form-group">
                <td></td>
                <td>
                  <select class="form-control" disabled>
                    <option value=""></option>
                    <option value="title" selected>Title</option>
                    <option value="body">Body</option>
                    <option value="tag">Tag</option>
                  </select>
                </td>
                <td>
                  <select class="form-control" disabled>
                    <option value="contains">contains</option>
                    <option value="equal">=</option>
                  </select>
                </td>
                <td>
                  <input type="text" value="" class="form-control" />
                </td>
                <td>
                  <button type="button" class="close" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          </form>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <button type="button" class="btn btn-primary add-rule" style="display: none">Add</button>
          <button type="button" class="btn btn-primary clear-posts">Clear</button>
        </div>
      </div>
      <hr/>
      <div id="post-table">
        <div class="row">
          <div class="col-md-6">Title</div>
          <div class="col-md-3">Author</div>
          <div class="col-md-3">Created</div>
        </div>
      </div>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
    <script>
      $('.clear-posts').on('click', function() {
        const tableHeader = $('#post-table .row:first');
        $('#post-table').html(tableHeader);
      });

      $('.add-rule').on('click', function() {
        if ($('#rule-table tbody tr').length > 5) {
          return false;
        }

        const condTr = '\
              <tr class="form-group">\
                <td>\
                  <select class="form-control">\
                    <option value="and">AND</option>\
                    <option value="or">OR</option>\
                  </select>\
                </td>\
                <td>\
                  <select class="form-control">\
                    <option value=""></option>\
                    <option value="title">Title</option>\
                    <option value="body">Body</option>\
                    <option value="tag">Tag</option>\
                  </select>\
                </td>\
                <td>\
                  <select class="form-control">\
                    <option value="contains">contains</option>\
                    <option value="equal">=</option>\
                  </select>\
                </td>\
                <td>\
                  <input type="text" value="" class="form-control" />\
                </td>\
                <td>\
                  <button type="button" class="close" aria-label="Close">\
                    <span aria-hidden="true">&times;</span>\
                  </button>\
                </td>\
              </tr>';

        $('#rule-table tbody').append(condTr);
        if ($('#rule-table tbody tr').length >= 5) {
          $('.add-rule').prop('disabled', true);
        }
      });

      $('#rule-table tbody').on('click', '.close', function(event) {
        if ($('#rule-table tbody tr').length > 1) {
          $(this).closest('tr').remove();
        }

        if ($('#rule-table tbody tr').length < 5) {
          $('.add-rule').prop('disabled', false);
        }
      });

      var outputted = false;
      steem.api.streamTransactions(function (err, transaction) {
        const operations = transaction.operations[0];

        if (operations[0] === 'comment' && operations[1].parent_author === '') {
          let jsonMetadata;
          let created;
          try {
            jsonMetadata = JSON.parse(operations[1].json_metadata);
            created = new Date(transaction.expiration);
          } catch (err) {
          }

          const title = operations[1].title;
          const titleCond = $(".form-group input[type=text]").val();

          if (title.indexOf(titleCond) > 0) {
            console.log("Title : " + operations[1].title);

            const author = operations[1].author;
            const steemitProfile = `https://steemit.com/@${author}`;
            const permlink = operations[1].permlink;
            console.log("Created : " + created.toLocaleString());
            const link = `https://steemit.com/@${author}/${permlink}`;

            const postTr = `
                <div class="row">
                  <div class="col-md-6"><a target="_blank" href="${link}">${title}</a></div>
                  <div class="col-md-3"><a target="_blank" href="${steemitProfile}">${author}</a></div>
                  <div class="col-md-3">${created}</div>
                </div>`;

            $(postTr).insertAfter('#post-table .row:first');
          }
        }
      });

    </script>
  </body>
</html>